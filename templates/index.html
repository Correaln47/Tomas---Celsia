<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Emotion Interaction</title>
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body>
    <div id="main-container">
      
      <div id="faceContainer">
        <canvas id="faceCanvas"></canvas>
        <img id="specialOverlay" src="static/media/Tomas.jpg" alt="Superposición Especial">
      </div>

      <audio id="specialAudio" src="static/media/uso.mp3"></audio>

      <img id="videoFeed" src="/video_feed" alt="Live Video Feed">

      <div id="snapshot-container" style="display:none;">
        <img id="snapshot" src="/snapshot" alt="Detected Snapshot">
        <p id="emotionText"></p>
      </div>
      
      <div id="carousel-container">
        <div id="carousel-track">
          </div>
      </div>
      <div class="power-button-comment">
        <p>Botón de apagado <br> (detrás del robot)</p>
        <div class="arrow">⬇️</div>
      </div>

    </div>

    <div id="video-container">
      <video id="interactionVideo" controls autoplay></video>
    </div>

    <script src="/static/js/script.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const carouselContainer = document.getElementById('carousel-container');
        const track = document.getElementById('carousel-track');
        
        const imageFiles = {{ image_files|tojson }};

        if (imageFiles && imageFiles.length > 0) {
            
            carouselContainer.style.display = 'block';
            track.innerHTML = '';
            const uploadServerUrl = 'http://' + window.location.hostname + ':5002';

            // --- LÓGICA DE LLENADO Y DUPLICACIÓN ---

            // 1. Crear un fragmento de documento para añadir todas las imágenes de una vez (más eficiente)
            const fragment = document.createDocumentFragment();
            let originalImages = [];

            imageFiles.forEach(url => {
                const img = document.createElement('img');
                img.src = uploadServerUrl + url;
                originalImages.push(img);
                fragment.appendChild(img);
            });

            // 2. Añadir el primer set de imágenes al track para poder medir su ancho
            track.appendChild(fragment);

            // 3. Esperar un momento para que el navegador renderice y calcule los anchos
            setTimeout(() => {
                // Calcular el ancho total del set original de imágenes
                const trackWidth = track.scrollWidth;
                const screenWidth = window.innerWidth;

                // Calcular cuántas veces necesitamos duplicar el contenido para llenar la pantalla
                // y tener suficiente para un bucle suave.
                const repeatsNeeded = Math.ceil(screenWidth / trackWidth) + 1;

                // 4. Clonar y añadir los sets de imágenes necesarios
                for (let i = 0; i < repeatsNeeded; i++) {
                    originalImages.forEach(img => {
                        track.appendChild(img.cloneNode(true));
                    });
                }
                
                // 5. Establecer la duración de la animación para una velocidad constante
                //    (Ancho total de la pista / píxeles por segundo)
                const finalWidth = track.scrollWidth;
                const speed = 80; // 80 píxeles por segundo, puedes ajustar este valor
                const animationDuration = finalWidth / speed;

                track.style.animationDuration = animationDuration + 's';
                // La animación 'scroll' del CSS se encargará del resto

            }, 100); // 100ms de espera

        } else {
            console.log('No se encontraron imágenes para el carrusel.');
            carouselContainer.style.display = 'none';
        }
      });
    </script>
    </body>
</html>