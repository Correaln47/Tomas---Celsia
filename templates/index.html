<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Emotion Interaction</title>
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body>
    <div id="main-container">
      
      <div id="faceContainer">
        <canvas id="faceCanvas"></canvas>
        <img id="specialOverlay" src="static/media/Tomas.jpg" alt="Superposición Especial">
      </div>

      <audio id="specialAudio" src="static/media/uso.mp3"></audio>

      <img id="videoFeed" src="/video_feed" alt="Live Video Feed">

      <div id="snapshot-container" style="display:none;">
        <img id="snapshot" src="/snapshot" alt="Detected Snapshot">
        <p id="emotionText"></p>
      </div>
      
      <div id="carousel-container">
        <div id="carousel-track">
          </div>
      </div>
      <div class="power-button-comment">
        <p>Botón de apagado <br> (detrás del robot)</p>
        <div class="arrow">⬇️</div>
      </div>

    </div>

    <div id="video-container">
      <video id="interactionVideo" controls autoplay></video>
    </div>

    <script src="/static/js/script.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const carouselContainer = document.getElementById('carousel-container');
        const track = document.getElementById('carousel-track');
        
        const imageFiles = {{ image_files|tojson }};

        if (imageFiles && imageFiles.length > 0) {
            
            carouselContainer.style.display = 'block';
            track.innerHTML = '';
            const uploadServerUrl = 'http://' + window.location.hostname + ':5002';
            let originalImages = [];
            
            // Usamos promesas para asegurarnos de que todas las imágenes se carguen antes de calcular anchos
            const imageLoadPromises = imageFiles.map(imageUrl => {
                return new Promise((resolve, reject) => {
                    const imgElement = document.createElement('img');
                    imgElement.src = uploadServerUrl + imageUrl;
                    imgElement.onload = () => {
                        originalImages.push(imgElement);
                        resolve(imgElement);
                    };
                    imgElement.onerror = reject;
                });
            });

            // Cuando todas las imágenes originales se hayan cargado...
            Promise.all(imageLoadPromises).then(() => {
                // Calcular el ancho total del set original de imágenes (incluyendo márgenes)
                let originalWidth = 0;
                originalImages.forEach(img => {
                    // El ancho de la imagen + su margen izquierdo + su margen derecho
                    originalWidth += img.offsetWidth + (2 * 20); // 20px es el margen que pusimos en el CSS
                });

                // Para un bucle perfecto, la pista debe ser al menos el doble de ancha que la pantalla
                // Duplicamos el contenido hasta que sea lo suficientemente largo
                let finalImages = [...originalImages];
                let currentWidth = originalWidth;

                while (currentWidth < (2 * window.innerWidth)) {
                    finalImages = [...finalImages, ...originalImages.map(img => img.cloneNode(true))];
                    currentWidth *= 2;
                }

                // Añadimos todas las imágenes al track
                finalImages.forEach(img => {
                    track.appendChild(img);
                });

                // 3. ANIMACIÓN CORREGIDA
                // Establecemos la variable CSS con la distancia exacta de desplazamiento
                track.style.setProperty('--scroll-width', `-${originalWidth}px`);

                // La duración se basa en el ancho para una velocidad constante
                const animationDuration = originalWidth / 100; // 100 píxeles por segundo (ajusta para más velocidad)
                
                track.style.animation = `scroll ${animationDuration}s linear infinite`;
            
            }).catch(error => {
                console.error("Una o más imágenes del carrusel no se pudieron cargar.", error);
                carouselContainer.style.display = 'none';
            });

        } else {
            console.log('No se encontraron imágenes para el carrusel.');
            carouselContainer.style.display = 'none';
        }
      });
    </script>
    </body>
</html>